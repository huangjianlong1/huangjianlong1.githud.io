<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>项目管理表 - 实时协作版</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        /* ... 中间样式省略 ... */
    </style>
    <!-- 引入腾讯云 CloudBase SDK -->
    <script src="https://unpkg.com/@cloudbase/js-sdk@latest/dist/tcb.js"></script>
    <!-- 引入 SheetJS 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <!-- 汇总区域 -->
    <div class="summary-section">
        <!-- ... 中间结构省略 ... -->
    </div>

    <!-- 输入部分 -->
    <div class="input-group">
        <!-- ... 输入框和按钮省略 ... -->
    </div>

    <!-- 表格部分 -->
    <table id="projectTable">
        <!-- ... 表格头省略 ... -->
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        // -------------------- 腾讯云 CloudBase 初始化 --------------------
        const app = tcb.init({
            env: 'qingkuanjihua-8ge50v1xb1d65b5c'
        });
        const db = app.database();
        const tableRef = db.collection('projectTable'); // 数据库中的集合名

        // -------------------- 全局变量 --------------------
        let currentRows = {}; // 存储当前行数据（CloudBase 文档 ID: 行数据）

        // -------------------- 初始化渲染 --------------------
        function initRender() {
            // 监听数据库实时更新
            tableRef.where({}).watch({
                onChange: (snapshot) => {
                    snapshot.docChanges.forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            currentRows[change.doc._id] = change.doc;
                        } else if (change.type === 'removed') {
                            delete currentRows[change.doc._id];
                        }
                    });
                    renderTable(currentRows); // 渲染表格
                    initProjectSlicer(); // 初始化项目筛选
                    updateSummary(); // 更新汇总
                },
                onError: (err) => {
                    console.error('监听数据库更新出错:', err);
                }
            });
        }

        // -------------------- 表格渲染函数 --------------------
        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // 清空原有内容

            Object.keys(data).forEach(key => {
                const rowData = data[key];
                const newRow = document.createElement('tr');
                
                // 绑定行删除事件（通过自定义属性存储 CloudBase 文档 ID）
                newRow.dataset.cloudbaseId = key;
                newRow.onclick = function(e) {
                    if (e.target.tagName === 'TD' && e.target.contentEditable) return; // 跳过可编辑单元格
                    deleteRow(this); // 点击行删除
                };

                ['序号', '当前月份', '项目', '合同编号', '项目名称', 
                 '请款人员', '任务进程', '完成进度', '请款进度', 
                 '总包金额', '分包金额'].forEach((colName, index) => {
                    const td = document.createElement('td');
                    const value = rowData[colName];
                    
                    if (index === 7 || index === 8) {
                        // 进度条组件
                        td.appendChild(createProgressComponent(value, index, key));
                    } else {
                        td.contentEditable = true;
                        td.textContent = value;
                        td.onblur = function() {
                            updateCell(key, colName, this.textContent, index); // 失去焦点时更新数据库
                        };
                    }
                    newRow.appendChild(td);
                });
                tableBody.appendChild(newRow);
            });
        }

        // -------------------- 创建进度条组件 --------------------
        function createProgressComponent(progress, index, key) {
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            
            const progressBarFill = document.createElement('div');
            progressBarFill.className = `progress-bar-fill ${progress === 100? 'complete' : ''}`;
            progressBarFill.style.width = `${progress}%`;
            progressBarFill.textContent = `${progress}%`;

            const input = document.createElement('input');
            input.type = 'number';
            input.min = 0;
            input.max = 100;
            input.step = 1;
            input.value = progress;
            input.className = 'progress-edit-input';
            
            input.onfocusout = function() {
                const newProgress = parseFloat(this.value);
                if (!isNaN(newProgress)) {
                    updateCell(key, index === 7? '完成进度' : '请款进度', newProgress, index); // 更新数据库
                    progressBarFill.style.width = `${newProgress}%`;
                    progressBarFill.textContent = `${newProgress}%`;
                    progressBarFill.className = `progress-bar-fill ${newProgress === 100? 'complete' : ''}`;
                } else {
                    this.value = progress;
                }
            };

            progressBar.appendChild(progressBarFill);
            progressBar.appendChild(input);
            return progressBar;
        }

        // -------------------- 更新单元格数据到腾讯云 CloudBase --------------------
        function updateCell(key, colName, value, index) {
            // 处理进度条的百分比转换
            const updatedValue = (index === 7 || index === 8)? 
                parseFloat(value) : value;
            
            tableRef.doc(key).update({
                [colName]: updatedValue
            }).catch(err => {
                console.error('更新单元格数据出错:', err);
            });
        }

        // -------------------- 添加行功能（整合腾讯云 CloudBase）--------------------
        function addRow() {
            const inputFields = [
                'currentMonth', 'project', 'contractNumber', 'projectName',
                'paymentPerson', 'taskProcess', 'completionProgress',
                'paymentProgress', 'totalContractAmount', 'subcontractAmount'
            ];
            const values = inputFields.map(id => document.getElementById(id).value);

            // 验证必填项
            if (values.some(v => v === '')) {
                alert('请填写所有必填信息');
                return;
            }

            const newRowData = {
                序号: Object.keys(currentRows).length + 1,
                当前月份: values[0],
                项目: values[1],
                合同编号: values[2],
                项目名称: values[3],
                请款人员: values[4],
                任务进程: values[5],
                完成进度: parseFloat(values[6]),
                请款进度: parseFloat(values[7]),
                总包金额: values[8],
                分包金额: values[9]
            };

            tableRef.add(newRowData).then(res => {
                currentRows[res.id] = newRowData;
            }).catch(err => {
                console.error('添加行数据出错:', err);
            });

            // 清空输入框
            inputFields.forEach(id => document.getElementById(id).value = '');
        }

        // -------------------- 删除行功能（整合腾讯云 CloudBase）--------------------
        function deleteRow(row) {
            const key = row.dataset.cloudbaseId;
            tableRef.doc(key).remove().catch(err => {
                console.error('删除行数据出错:', err);
            });
        }

        // -------------------- 数据导入（写入腾讯云 CloudBase）--------------------
        function importXLSX() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // 批量写入数据库
                data.forEach(row => {
                    tableRef.add({
                        序号: row.序号,
                        当前月份: row.当前月份,
                        项目: row.项目,
                        合同编号: row.合同编号,
                        项目名称: row.项目名称,
                        请款人员: row.请款人员,
                        任务进程: row.任务进程,
                        完成进度: parseFloat(row.完成进度),
                        请款进度: parseFloat(row.请款进度),
                        总包金额: row.总包金额,
                        分包金额: row.分包金额
                    }).catch(err => {
                        console.error('导入数据出错:', err);
                    });
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // -------------------- 原有功能适配修改 --------------------
        // 初始化月份切片器（保持不变）
        function initMonthSlicer() { /* 原有代码不变 */ }

        // 初始化项目切片器（从数据库数据获取）
        function initProjectSlicer() {
            const projectSlicer = document.getElementById('projectSlicer');
            projectSlicer.innerHTML = '<option value="">所有项目</option>';
            const projects = new Set();
            Object.values(currentRows).forEach(row => projects.add(row.项目));
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSlicer.appendChild(option);
            });
        }

        // 分类汇总函数（从表格实时数据计算）
        function summarizeData() { /* 原有代码不变，依赖实时渲染的表格数据 */ }

        // 页面加载时初始化腾讯云 CloudBase 监听
        window.addEventListener('load', () => {
            initMonthSlicer();
            initRender(); // 替换原本地存储加载
        });

        // 其他功能：筛选、排序、导出保持不变（依赖实时渲染的表格）
        function filterRows() { /* 原有代码不变 */ }
        function sortRows() { /* 原有代码不变 */ }
        function exportToCSV() { /* 原有代码不变 */ }

        // 切片器事件监听保持不变
        document.getElementById('monthSlicer').addEventListener('change', updateSummary);
        document.getElementById('projectSlicer').addEventListener('change', updateSummary);
        document.getElementById('progressSlicer').addEventListener('change', updateSummary);
    </script>
</body>

</html>
    
