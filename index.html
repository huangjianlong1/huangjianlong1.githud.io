<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>项目数据管理系统</title>
    <style>
        /* 综合样式优化 */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f6fa;
        }

        .toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
        }

        .import-btn {
            background-color: #3498db;
            color: white;
            border: none;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th, td {
            border: 1px solid #ecf0f1;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .progress-cell {
            min-width: 120px;
        }

        .progress-bar {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <input type="text" class="search-box" placeholder="搜索项目名称或合同编号..." id="searchInput">
        <button class="action-btn export-btn" onclick="exportData()">导出Excel</button>
        <label class="action-btn import-btn">
            导入Excel
            <input type="file" id="importFile" style="display: none;" onchange="importData()">
        </label>
    </div>

    <table id="projectTable">
        <thead>
            <tr>
                <th>当前月份</th>
                <th>项目</th>
                <th>合同编号</th>
                <th>项目名称</th>
                <th>请款人员</th>
                <th>任务进程</th>
                <th class="progress-cell">完成进度</th>
                <th class="progress-cell">请款进度</th>
                <th>总包金额</th>
                <th>分包金额</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- 数据动态加载 -->
        </tbody>
    </table>

    <script>
        // 初始化加载数据
        document.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            try {
                const response = await fetch(`/api/requests?filterByFormula=${buildFilterFormula()}`);
                const data = await response.json();
                renderTable(data);
            } catch (error) {
                alert('数据加载失败: ' + error.message);
            }
        }

        function buildFilterFormula() {
            const searchText = document.getElementById('searchInput').value;
            if (!searchText) return '';
            return `SEARCH("${searchText}", {项目名称}) + SEARCH("${searchText}", {合同编号})`;
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');
                
                // 公共单元格创建方法
                const createCell = (content, isProgress = false) => {
                    const td = document.createElement('td');
                    if (isProgress) {
                        const progress = content * 100;
                        td.innerHTML = `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <span>${Math.round(progress)}%</span>
                        `;
                    } else {
                        td.textContent = content || '-';
                    }
                    return td;
                };

                // 填充数据
                row.appendChild(createCell(item.yuefen?.[0]));
                row.appendChild(createCell(item.xiangmu?.[0]));
                row.appendChild(createCell(item.hetongbianhao));
                row.appendChild(createCell(item.xiangmumingcheng));
                row.appendChild(createCell(item.qingkuanrenyuan));
                row.appendChild(createCell(item.renwujingcheng));
                row.appendChild(createCell(item.wanchengjingdu, true));
                row.appendChild(createCell(item.qingkuanbili, true));
                row.appendChild(createCell(item.zongbaoqingkuanjinger));
                row.appendChild(createCell(item.fenbaoqingkuanjinger));

                // 添加删除按钮
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.textContent = '删除';
                deleteBtn.onclick = () => deleteItem(item.id);
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);

                tbody.appendChild(row);
            });
        }

        async function deleteItem(recordId) {
            if (confirm('确定要删除这条记录吗？')) {
                try {
                    const response = await fetch(`/api/requests/${recordId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) loadData();
                } catch (error) {
                    alert('删除失败: ' + error.message);
                }
            }
        }

        async function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    alert('导入成功！');
                    loadData();
                }
            } catch (error) {
                alert('导入失败: ' + error.message);
            }
        }

        function exportData() {
            window.location.href = '/api/export';
        }
    </script>
</body>
</html>
