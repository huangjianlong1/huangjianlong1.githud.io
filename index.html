<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>项目管理表</title>
    <style>
        /* 样式部分与原代码一致，此处省略以保持简洁，可直接复用原样式 */
    </style>
    <!-- 引入 SheetJS 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <!-- 汇总区域、输入部分、筛选排序、导出导入、表格部分的HTML结构与原代码一致 -->

    <script>
        const API_URL = 'http://localhost:5000/api/projects'; // 后端API地址
        let tableData = []; // 存储表格数据

        // 初始化月份切片器
        function initMonthSlicer() {
            const monthSlicer = document.getElementById('monthSlicer');
            ['1月', '2月', '3月', '4月', '5月', '6月', 
             '7月', '8月', '9月', '10月', '11月', '12月']
             .forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSlicer.appendChild(option);
            });
        }

        // 初始化项目切片器（从API数据获取）
        function initProjectSlicer() {
            const projectSlicer = document.getElementById('projectSlicer');
            projectSlicer.innerHTML = '<option value="">所有项目</option>';
            const projects = new Set(tableData.map(item => item.project));
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSlicer.appendChild(option);
            });
        }

        // 渲染表格数据
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            tableData.forEach((item, index) => {
                const newRow = document.createElement('tr');
                newRow.dataset.id = item._id; // 存储后端返回的ID
                
                const columns = [
                    index + 1,
                    item.currentMonth,
                    item.project,
                    item.contractNumber,
                    item.projectName,
                    item.paymentPerson,
                    item.taskProcess,
                    item.completionProgress,
                    item.paymentProgress,
                    item.totalContractAmount,
                    item.subcontractAmount
                ];

                columns.forEach((col, colIndex) => {
                    const td = document.createElement('td');
                    if (colIndex === 7 || colIndex === 8) {
                        // 进度条组件
                        const progressBar = createProgressBar(col, item._id, colIndex === 7);
                        td.appendChild(progressBar);
                    } else {
                        td.contentEditable = true;
                        td.textContent = col;
                        // 普通字段编辑事件
                        td.addEventListener('blur', async (e) => {
                            await updateField(item._id, e.target.cellIndex, e.target.textContent);
                        });
                    }
                    newRow.appendChild(td);
                });

                // 删除按钮
                const deleteTd = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '删除';
                deleteBtn.className = 'delete-btn';
                deleteBtn.addEventListener('click', () => deleteRow(item._id));
                deleteTd.appendChild(deleteBtn);
                newRow.appendChild(deleteTd); // 添加删除列（需在表格thead添加对应th）

                tableBody.appendChild(newRow);
            });

            initProjectSlicer();
            updateSummary();
        }

        // 创建进度条组件
        function createProgressBar(progress, projectId, isCompletion) {
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            
            const progressBarFill = document.createElement('div');
            progressBarFill.className = `progress-bar-fill ${progress === 100? 'complete' : ''}`;
            progressBarFill.style.width = `${progress}%`;
            progressBarFill.textContent = `${progress}%`;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.min = 0;
            input.max = 100;
            input.step = 1;
            input.value = progress;
            input.className = 'progress-edit-input';
            
            input.addEventListener('focusout', async (e) => {
                const newProgress = parseFloat(e.target.value);
                if (!isNaN(newProgress)) {
                    await updateProgress(projectId, isCompletion? 'completionProgress' : 'paymentProgress', newProgress);
                    progressBarFill.style.width = `${newProgress}%`;
                    progressBarFill.textContent = `${newProgress}%`;
                    progressBarFill.className = `progress-bar-fill ${newProgress === 100? 'complete' : ''}`;
                }
            });

            progressBar.appendChild(progressBarFill);
            progressBar.appendChild(input);
            return progressBar;
        }

        // 获取所有数据
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('数据获取失败');
                tableData = await response.json();
                renderTable();
            } catch (error) {
                alert('加载数据失败，请检查服务器连接');
                console.error(error);
            }
        }

        // 添加行
        async function addRow() {
            const formData = {
                currentMonth: document.getElementById('currentMonth').value,
                project: document.getElementById('project').value,
                contractNumber: document.getElementById('contractNumber').value,
                projectName: document.getElementById('projectName').value,
                paymentPerson: document.getElementById('paymentPerson').value,
                taskProcess: document.getElementById('taskProcess').value,
                completionProgress: parseFloat(document.getElementById('completionProgress').value),
                paymentProgress: parseFloat(document.getElementById('paymentProgress').value),
                totalContractAmount: parseFloat(document.getElementById('totalContractAmount').value),
                subcontractAmount: parseFloat(document.getElementById('subcontractAmount').value)
            };

            if (validateForm(formData)) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    if (response.ok) {
                        const newItem = await response.json();
                        tableData.push(newItem);
                        renderTable();
                        clearInputs();
                    } else {
                        const error = await response.text();
                        alert(error || '添加失败');
                    }
                } catch (error) {
                    alert('添加失败，请重试');
                    console.error(error);
                }
            }
        }

        // 更新普通字段
        async function updateField(projectId, column, value) {
            const field = ['currentMonth', 'project', 'contractNumber', 
                           'projectName', 'paymentPerson', 'taskProcess'][column];
            if (field) {
                try {
                    await fetch(`${API_URL}/${projectId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ [field]: value })
                    });
                    tableData = tableData.map(item => 
                        item._id === projectId? { ...item, [field]: value } : item
                    );
                } catch (error) {
                    console.error('更新失败', error);
                }
            }
        }

        // 更新进度字段
        async function updateProgress(projectId, field, value) {
            try {
                await fetch(`${API_URL}/${projectId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
                tableData = tableData.map(item => 
                    item._id === projectId? { ...item, [field]: value } : item
                );
            } catch (error) {
                console.error('进度更新失败', error);
            }
        }

        // 删除行
        async function deleteRow(projectId) {
            try {
                const response = await fetch(`${API_URL}/${projectId}`, { method: 'DELETE' });
                if (response.ok) {
                    tableData = tableData.filter(item => item._id !== projectId);
                    renderTable();
                }
            } catch (error) {
                alert('删除失败，请重试');
                console.error(error);
            }
        }

        // 表单验证
        function validateForm(data) {
            const requiredFields = ['currentMonth', 'project', 'contractNumber', 
                                    'projectName', 'paymentPerson', 'taskProcess',
                                    'completionProgress', 'paymentProgress',
                                    'totalContractAmount', 'subcontractAmount'];
            for (const field of requiredFields) {
                if (!data[field] || (['completionProgress', 'paymentProgress'].includes(field) && isNaN(data[field]))) {
                    alert(`请填写有效的 ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} 字段`);
                    return false;
                }
            }
            return true;
        }

        // 清空输入框
        function clearInputs() {
            document.querySelectorAll('.input-group input').forEach(input => input.value = '');
        }

        // 分类汇总（修改为从tableData获取数据）
        function summarizeData() {
            const monthFilter = document.getElementById('monthSlicer').value;
            const projectFilter = document.getElementById('projectSlicer').value;
            const progressFilter = document.getElementById('progressSlicer').value;

            let totalContractInProgressAmount = 0;
            let totalContractCompletedAmount = 0;
            let subcontractInProgressAmount = 0;
            let subcontractCompletedAmount = 0;
            let totalContractInProgressCount = 0;
            let totalContractCompletedCount = 0;
            let subcontractInProgressCount = 0;
            let subcontractCompletedCount = 0;

            tableData.forEach(item => {
                const progress = item.completionProgress;
                const monthMatch = !monthFilter || item.currentMonth === monthFilter;
                const projectMatch = !projectFilter || item.project === projectFilter;
                const progressMatch = (() => {
                    if (!progressFilter) return true;
                    if (progressFilter === '进行中') return progress < 100;
                    if (progressFilter === '已完成') return progress === 100;
                    return false;
                })();

                if (monthMatch && projectMatch && progressMatch) {
                    if (progress === 100) {
                        totalContractCompletedAmount += item.totalContractAmount;
                        subcontractCompletedAmount += item.subcontractAmount;
                        totalContractCompletedCount++;
                        subcontractCompletedCount++;
                    } else {
                        totalContractInProgressAmount += item.totalContractAmount;
                        subcontractInProgressAmount += item.subcontractAmount;
                        totalContractInProgressCount++;
                        subcontractInProgressCount++;
                    }
                }
            });

            return {
                totalContractInProgressAmount,
                totalContractCompletedAmount,
                totalContractInProgressCount,
                totalContractCompletedCount,
                subcontractInProgressAmount,
                subcontractCompletedAmount,
                subcontractInProgressCount,
                subcontractCompletedCount
            };
        }

        // 更新汇总显示
        function updateSummary() {
            const summary = summarizeData();
            // 与原代码相同的汇总HTML更新逻辑，此处省略（可直接复用原代码中的DOM操作）
        }

        // 切片器事件监听
        document.querySelectorAll('.slicer select').forEach(select => {
            select.addEventListener('change', updateSummary);
        });

        // 导入功能（修改为文件上传）
        async function importXLSX() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('http://localhost:5000/api/import', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    alert('导入成功');
                    await fetchData(); // 重新加载数据
                } else {
                    alert('导入失败');
                }
            } catch (error) {
                console.error('导入错误', error);
            }
        }

        // 导出功能（修改为从API获取文件流）
        function exportToCSV() {
            window.location.href = 'http://localhost:5000/api/export';
        }

        // 页面加载时初始化
        window.addEventListener('load', async () => {
            initMonthSlicer();
            await fetchData(); // 从后端加载数据
            // 初始化筛选、排序等事件（与原代码逻辑一致，需保持DOM操作正确）
        });

        // 筛选、排序等功能（与原代码逻辑一致，仅数据来源改为tableData，需调整DOM操作）
        function filterRows() {
            const filterValue = document.getElementById('filterInput').value.toLowerCase();
            const tableRows = document.querySelectorAll('#tableBody tr');
            tableRows.forEach(row => {
                const contractNumber = row.cells[3].textContent.toLowerCase();
                const projectName = row.cells[4].textContent.toLowerCase();
                row.style.display = (contractNumber.includes(filterValue) || projectName.includes(filterValue))? '' : 'none';
            });
        }

        function sortRows() {
            tableData.sort((a, b) => a.contractNumber.localeCompare(b.contractNumber));
            renderTable();
        }
    </script>
</body>

</html>
